# .NET Aspire Projects with AZD

**⛔ MANDATORY: For .NET Aspire projects, NEVER manually create azure.yaml. Use `azd init --from-code` instead.**

## Detection

A .NET Aspire project is identified by:

| Indicator | How to Detect |
|-----------|---------------|
| `*.AppHost.csproj` | Find files ending with `.AppHost.csproj` (e.g., `MyApp.AppHost.csproj`) |
| `Aspire.Hosting` package | Search for `<PackageReference Include="Aspire.Hosting"` in `.csproj` files |
| `Aspire.AppHost.Sdk` | Check for `<Project Sdk="Aspire.AppHost.Sdk">` in `.csproj` files |

**Detection commands:**
```bash
# Find AppHost project files
find . -name "*.AppHost.csproj" -o -name "*AppHost.csproj"

# Search for Aspire.Hosting package references
grep -r "Aspire\.Hosting" . --include="*.csproj"

# Search for Aspire.AppHost.Sdk
grep -r "Aspire\.AppHost\.Sdk" . --include="*.csproj"
```

## Workflow

### ⛔ DO NOT Do This (Wrong Approach)

```yaml
# ❌ WRONG - Do NOT manually create azure.yaml for Aspire projects
name: aspire-with-azure-functions
metadata:
  template: azd-init
# ❌ Missing services section - causes "Could not find infra\main.bicep" error
```

**Why this fails:**
- Missing `services` section means azd doesn't know about the AppHost
- azd looks for `infra/main.bicep` which doesn't exist yet
- Aspire auto-generates infrastructure from AppHost code - manual Bicep is not needed
- The AppHost service definitions are ignored

### ✅ DO This (Correct Approach)

**Use `azd init --from-code` which:**
1. Auto-detects the AppHost orchestrator from `*.AppHost.csproj`
2. Reads Aspire service definitions from AppHost code
3. Generates correct `azure.yaml` with `services` section
4. Auto-generates infrastructure files in `infra/` directory
5. Works in non-interactive/CI environments

```bash
# Generate environment name from directory
ENV_NAME="$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | tr ' _' '-')-dev"

# Initialize with auto-detection
azd init --from-code -e "$ENV_NAME"
```

**What this generates:**

```yaml
# ✅ CORRECT - Generated by azd init --from-code
name: aspire-with-azure-functions
metadata:
  template: azd-init

services:
  app:
    language: dotnet
    project: ./ImageGallery.AppHost/ImageGallery.AppHost.csproj
    host: containerapp
```

## Command Reference

| Flag | Required | Purpose |
|------|----------|---------|
| `--from-code` | ✅ Yes | Auto-detect AppHost without interactive prompts |
| `-e <name>` | ✅ Yes | Environment name (required for non-interactive mode) |
| `--no-prompt` | Optional | Skip all confirmations |

**Why `--from-code` is critical:**
- Without it: `azd init` prompts "How do you want to initialize your app?" - requires TTY interaction
- With it: Automatically detects AppHost and proceeds without prompts
- Essential for agents, automation, and CI/CD pipelines

## Docker Context Handling

When Aspire AppHost uses `AddDockerfile` to add containerized services:

```csharp
// AppHost code
builder.AddDockerfile("ginapp", "./ginapp");
```

The generated `azure.yaml` includes the Docker build context:

```yaml
services:
  ginapp:
    language: dotnet
    host: containerapp
    docker:
      path: ./ginapp/Dockerfile
      context: ./ginapp
```

**The `context` field:**
- Specifies the Docker build context directory
- Extracted from the second parameter of `AddDockerfile(name, context)`
- Critical for multi-service repos where each service has its own context

## Common Samples

| Sample | Repository Path | Notes |
|--------|----------------|-------|
| aspire-with-azure-functions | [dotnet/aspire-samples/samples/aspire-with-azure-functions](https://github.com/dotnet/aspire-samples/tree/main/samples/aspire-with-azure-functions) | Functions + Aspire integration |
| container-build | [dotnet/aspire-samples/samples/container-build](https://github.com/dotnet/aspire-samples/tree/main/samples/container-build) | Multi-container with custom Dockerfiles |
| orleans-voting | [dotnet/aspire-samples/samples/orleans-voting](https://github.com/dotnet/aspire-samples/tree/main/samples/orleans-voting) | Orleans cluster |
| eShop | [dotnet/eShop](https://github.com/dotnet/eShop) | Full microservices reference app |

## Troubleshooting

### Error: "Could not find a part of the path 'infra\main.bicep'"

**Cause:** Manually created `azure.yaml` without `services` section, or services don't reference AppHost.

**Solution:**
1. Delete the manually created `azure.yaml`
2. Run `azd init --from-code -e <env-name>` to regenerate
3. Verify `services` section includes AppHost project path

### Error: "no default response for prompt 'How do you want to initialize your app?'"

**Cause:** Missing `--from-code` flag when running `azd init`.

**Solution:** Always include `--from-code` flag for Aspire projects in automation/agent contexts:
```bash
azd init --from-code -e "$ENV_NAME"  # ✅ Correct
```

### AppHost Not Detected

**Symptoms:** `azd init --from-code` doesn't find the AppHost.

**Solutions:**
1. Verify AppHost project exists: `find . -name "*.AppHost.csproj"`
2. Check project builds successfully: `dotnet build`
3. Ensure `Aspire.Hosting` or `Aspire.AppHost.Sdk` is referenced
4. Verify you're running command from solution root directory

## Infrastructure Auto-Generation

Aspire projects don't need manual Bicep/Terraform files:

| Traditional AZD Project | Aspire Project |
|------------------------|----------------|
| Manually write `infra/main.bicep` | Auto-generated from AppHost |
| Define resources in IaC | Define resources in C# code |
| Update IaC for new services | Add services to AppHost |
| `azd provision` runs Bicep | `azd provision` generates + runs Bicep |

**How it works:**
1. AppHost code defines services and dependencies in C#
2. `azd provision` analyzes AppHost at provision time
3. Generates appropriate Bicep/ARM templates automatically
4. Deploys to Azure Container Apps environment

## Next Steps

After `azd init --from-code`:
1. Verify `azure.yaml` has correct `services` section
2. Review generated `infra/` files (informational - don't modify)
3. Set Azure subscription: `azd env set AZURE_SUBSCRIPTION_ID <id>`
4. Proceed to **azure-validate** skill
5. Deploy with **azure-deploy** skill (`azd up`)

## References

- [.NET Aspire Documentation](https://learn.microsoft.com/dotnet/aspire/)
- [azd + Aspire Integration](https://learn.microsoft.com/dotnet/aspire/deployment/azure/aca-deployment-azd-in-depth)
- [Aspire Samples Repository](https://github.com/dotnet/aspire-samples)
- [Main Aspire Guide](../../aspire.md)

# .NET Aspire Projects

Guidance for preparing .NET Aspire applications for Azure deployment.

## What is .NET Aspire?

.NET Aspire is an opinionated, cloud-ready stack for building observable, production-ready distributed applications. Aspire projects use an AppHost orchestrator to define and configure the application's components, services, and dependencies.

## Detection

A .NET Aspire project is identified by:

| Indicator | Description |
|-----------|-------------|
| `*.AppHost.csproj` | AppHost orchestrator project file |
| `Aspire.Hosting` package | Core Aspire hosting package reference |
| `Aspire.Hosting.AppHost` | Alternative Aspire hosting package |

**Example project structure:**
```
orleans-voting/
‚îú‚îÄ‚îÄ OrleansVoting.sln
‚îú‚îÄ‚îÄ OrleansVoting.AppHost/
‚îÇ   ‚îî‚îÄ‚îÄ OrleansVoting.AppHost.csproj   ‚Üê AppHost indicator
‚îú‚îÄ‚îÄ OrleansVoting.Web/
‚îú‚îÄ‚îÄ OrleansVoting.Api/
‚îî‚îÄ‚îÄ OrleansVoting.Grains/
```

## Azure Preparation Workflow

### Step 1: Detection

When scanning the codebase (per [scan.md](scan.md)), detect Aspire by:

```bash
# Check for AppHost project
find . -name "*.AppHost.csproj"

# Or check for Aspire.Hosting package reference
grep -r "Aspire.Hosting" . --include="*.csproj"
```

### Step 2: Initialize with azd

**CRITICAL: For Aspire projects, use `azd init --from-code -e <environment-name>` instead of creating azure.yaml manually.**

**‚ö†Ô∏è ALWAYS include the `-e <environment-name>` flag:** Without it, `azd init` will fail in non-interactive environments (agents, CI/CD) with the error: `no default response for prompt 'Enter a unique environment name:'`

The `--from-code` flag:
- Auto-detects the AppHost orchestrator
- Reads the Aspire service definitions
- Generates appropriate `azure.yaml` and infrastructure
- Works in non-interactive/CI environments when combined with `-e` flag

```bash
# Non-interactive initialization for Aspire projects (REQUIRED for agents)
ENV_NAME="$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | tr ' _' '-')-dev"
azd init --from-code -e "$ENV_NAME"
```

**Why both flags are required:**
- `--from-code`: Tells azd to detect the AppHost automatically (no "How do you want to initialize?" prompt)
- `-e <name>`: Provides environment name upfront (no "Enter environment name:" prompt)
- Together, they enable fully non-interactive operation essential for automation, agents, and CI/CD pipelines

### Step 3: What azd Generates

`azd init --from-code` creates:

| Artifact | Location | Description |
|----------|----------|-------------|
| `azure.yaml` | Project root | Service definitions from AppHost |
| `infra/` | Project root | Bicep templates for Azure resources |
| `.azure/` | Project root | Environment configuration |

**Example generated azure.yaml:**
```yaml
name: orleans-voting
# metadata section is auto-generated by azd init --from-code

services:
  web:
    project: ./OrleansVoting.Web
    language: dotnet
    host: containerapp

  api:
    project: ./OrleansVoting.Api
    language: dotnet
    host: containerapp
```

## Flags Reference

### azd init for Aspire

| Flag | Required | Description |
|------|----------|-------------|
| `--from-code` | ‚úÖ Yes | Auto-detect AppHost, no interactive prompts |
| `-e <name>` | ‚úÖ Yes | Environment name (required for non-interactive) |
| `--no-prompt` | Optional | Skip additional confirmations |

**Complete command:**
```bash
ENV_NAME="$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | tr ' _' '-')-dev"
azd init --from-code -e "$ENV_NAME"
```

## Common Aspire Samples

| Sample | Repository | Notes |
|--------|------------|-------|
| orleans-voting | [dotnet/aspire-samples](https://github.com/dotnet/aspire-samples/tree/main/samples/orleans-voting) | Orleans cluster with voting app |
| AspireYarp | [dotnet/aspire-samples](https://github.com/dotnet/aspire-samples/tree/main/samples/AspireYarp) | YARP reverse proxy |
| AspireWithDapr | [dotnet/aspire-samples](https://github.com/dotnet/aspire-samples/tree/main/samples/AspireWithDapr) | Dapr integration |
| eShop | [dotnet/eShop](https://github.com/dotnet/eShop) | Reference microservices app |

## Troubleshooting

### Error: "no default response for prompt 'Enter a unique environment name:'"

**Cause:** Missing `-e` flag when running `azd init --from-code` in non-interactive environment  
**Solution:** Always include the `-e <environment-name>` flag

```bash
# ‚ùå Wrong - fails in non-interactive environments (agents, CI/CD)
azd init --from-code

# ‚úÖ Correct - provides environment name upfront
ENV_NAME="$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | tr ' _' '-')-dev"
azd init --from-code -e "$ENV_NAME"
```

**Important:** This error typically occurs when:
- Running in an agent or automation context
- No TTY is available for interactive prompts
- The `-e` flag was omitted

### Error: "no default response for prompt 'How do you want to initialize your app?'"

**Cause:** Missing `--from-code` flag  
**Solution:** Add `--from-code` to the `azd init` command

```bash
# ‚ùå Wrong - requires interactive prompt
azd init -e "my-env"

# ‚úÖ Correct - auto-detects AppHost
azd init --from-code -e "my-env"
```

### No AppHost detected

**Symptoms:** `azd init --from-code` doesn't find the AppHost

**Solutions:**
1. Verify AppHost project exists: `find . -name "*.AppHost.csproj"`
2. Check project builds: `dotnet build`
3. Ensure Aspire.Hosting package is referenced in AppHost project

## References

- [.NET Aspire Documentation](https://learn.microsoft.com/en-us/dotnet/aspire/)
- [Azure Developer CLI (azd)](https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/)
- [Aspire Samples Repository](https://github.com/dotnet/aspire-samples)
- [azd + Aspire Integration](https://learn.microsoft.com/en-us/dotnet/aspire/deployment/azure/aca-deployment-azd-in-depth)

## Environment Variables for Container Apps

> ‚ö†Ô∏è **CRITICAL:** When using Aspire with Container Apps, azd may generate infrastructure in "limited mode" (in-memory) without populating all required environment variables. Follow these steps to ensure successful deployment.

### Required Variables

For Container Apps deployments with Azure Container Registry and Managed Identity, these environment variables are **required** by `azd deploy`:

| Variable | Purpose | Source |
|----------|---------|--------|
| `AZURE_CONTAINER_REGISTRY_ENDPOINT` | ACR login server URL | Container Registry resource |
| `AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID` | Full resource ID of managed identity | Managed Identity resource |
| `MANAGED_IDENTITY_CLIENT_ID` | Client ID of managed identity | Managed Identity resource |

### Proactive Setup (Recommended)

**Do this BEFORE running `azd up` to avoid deployment failures:**

#### Option 1: Use `azd infra synth` (azd 1.5.0+)

Generate explicit infrastructure with proper outputs:

```bash
# 1. After azd init, generate infrastructure to disk
azd infra synth

# 2. Add outputs to infra/main.bicep (or the main module file)
cat >> infra/main.bicep << 'EOF'

// Environment variables for Container Apps deployment
output AZURE_CONTAINER_REGISTRY_ENDPOINT string = containerRegistry.properties.loginServer
output AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID string = managedIdentity.id
output MANAGED_IDENTITY_CLIENT_ID string = managedIdentity.properties.clientId
EOF

# 3. Now azd up will automatically populate these variables
azd up --no-prompt
```

> üí° **Note:** Replace `containerRegistry` and `managedIdentity` with the actual Bicep resource names in your generated `infra/` files. Check `infra/main.bicep` or `infra/resources.bicep` for the exact resource declaration names.

#### Option 2: Set Variables After Provisioning

If you can't use `azd infra synth`, set variables manually after `azd provision`:

```bash
# 1. Provision infrastructure first
azd provision --no-prompt

# 2. Get resource group name
RG_NAME=$(azd env get-values | grep AZURE_RESOURCE_GROUP | cut -d'=' -f2 | tr -d '"')

# 3. Query and set required variables
azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT $(az acr list --resource-group "$RG_NAME" --query "[0].loginServer" -o tsv)
azd env set AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID $(az identity list --resource-group "$RG_NAME" --query "[0].id" -o tsv)
azd env set MANAGED_IDENTITY_CLIENT_ID $(az identity list --resource-group "$RG_NAME" --query "[0].clientId" -o tsv)

# 4. Deploy application
azd deploy --no-prompt
```

**PowerShell:**
```powershell
# 1. Provision infrastructure first
azd provision --no-prompt

# 2. Get resource group name
$rgName = (azd env get-values | Select-String 'AZURE_RESOURCE_GROUP').Line.Split('=')[1].Trim('"')

# 3. Query and set required variables
azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT (az acr list --resource-group $rgName --query "[0].loginServer" -o tsv)
azd env set AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID (az identity list --resource-group $rgName --query "[0].id" -o tsv)
azd env set MANAGED_IDENTITY_CLIENT_ID (az identity list --resource-group $rgName --query "[0].clientId" -o tsv)

# 4. Deploy application
azd deploy --no-prompt
```

### Why This is Needed

Aspire's "limited mode" generates infrastructure in-memory during `azd provision`. While it creates all necessary Azure resources (Container Registry, Managed Identity, Container Apps Environment), it doesn't populate the environment variables that reference those resources. The `azd deploy` phase needs these variables to:
- Log in to the Container Registry
- Configure Managed Identity authentication
- Set up Container App identity bindings

## Next Steps

After `azd init --from-code`:
1. Review generated `azure.yaml` and `infra/` files (if present)
2. **IMPORTANT:** Set up environment variables using one of the methods above
3. Customize infrastructure as needed
4. Proceed to **azure-validate** skill
5. Deploy with **azure-deploy** skill (`azd up` or `azd provision` + `azd deploy`)

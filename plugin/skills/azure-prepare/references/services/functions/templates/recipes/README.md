# Function Template Recipes

Composable IaC + source code modules that extend the HTTP base template
to support specific Azure service integrations.

## Architecture

```
HTTP Base Template (per language, from AZD gallery)
       â”‚
       â”œâ”€â”€ Source code (HTTP GET/POST)
       â”œâ”€â”€ IaC (Storage, App Insights, Flex Plan, UAMI, RBAC, VNet)
       â””â”€â”€ AZD config (azure.yaml, parameters)

       + Recipe (per integration)
       â”‚
       â”œâ”€â”€ Source code delta (trigger/binding snippet)
       â”œâ”€â”€ IaC delta (new resource + RBAC + networking modules)
       â””â”€â”€ App settings delta
       â”‚
       = Complete deployable project â†’ `azd up`
```

## Available Recipes

| Recipe | IaC Delta? | Source Delta? | Status |
|--------|-----------|--------------|--------|
| [cosmosdb](cosmosdb/README.md) | âœ… Cosmos account + DB + containers + RBAC + PE | âœ… CosmosDBTrigger | âœ… POC |
| servicebus | âœ… SB namespace + queue + RBAC + PE | âœ… ServiceBusTrigger | ğŸ”² Planned |
| sql | âœ… SQL server + DB + firewall + identity | âœ… SqlTrigger | ğŸ”² Planned |
| eventhubs | âœ… EH namespace + hub + consumer group + RBAC + PE | âœ… EventHubTrigger | ğŸ”² Planned |
| blob-eventgrid | âœ… EventGrid subscription + system topic | âœ… BlobTrigger (EG) | ğŸ”² Planned |
| timer | âŒ None | âœ… TimerTrigger + cron | ğŸ”² Planned |
| durable | âš™ï¸ Toggle `enableQueue`+`enableTable` in base | âœ… Orchestrator + Activity + Client | ğŸ”² Planned |
| mcp | âš™ï¸ Toggle `enableQueue`+`enableTable` in base | âœ… MCPTrigger / `@app.mcp_tool` | ğŸ”² Planned |

## How It Works

### Step 1: Fetch HTTP Base

```bash
# Bicep base (default)
azd init -t functions-quickstart-{language}-azd -e "$ENV_NAME" --no-prompt

# Terraform base
azd init -t functions-quickstart-{language}-azd-tf -e "$ENV_NAME" --no-prompt
```

### Step 2: Apply Recipe

The skill reads the recipe's README.md for:
- **IaC module files** to copy into `infra/`
- **App settings** to add to function app config
- **RBAC roles** with exact GUIDs (never generated by LLM)
- **Source code** to replace HTTP trigger with integration trigger
- **Networking** to add private endpoints (conditional on VNET_ENABLED)

### Step 3: Wire Into Base

**Bicep:** Add `module` reference in `main.bicep`, pass `functionAppPrincipalId`
**Terraform:** Copy `.tf` file into `infra/`, merge `locals.cosmos_app_settings` into function app

### Step 4: Deploy

```bash
azd up --no-prompt
```

## Design Principles

| Principle | Why |
|-----------|-----|
| **Never synthesize base IaC** | Always use proven AZD template repos |
| **Never modify base; only extend** | Recipes are additive modules â€” no risk of breaking core |
| **Recipes own their RBAC** | Exact role GUIDs, no LLM guessing |
| **Recipes own their networking** | Private endpoints per service, fully tested |
| **Same algorithm for Bicep & Terraform** | Only IaC files differ, not composition logic |
| **Source snippets per language** | Small, deterministic, tested code blocks |

## Base Templates

| Language | Bicep Template | Terraform Template |
|----------|---------------|-------------------|
| C# (.NET) | `functions-quickstart-dotnet-azd` | `functions-quickstart-dotnet-azd-tf` |
| TypeScript | `functions-quickstart-typescript-azd` | `functions-quickstart-typescript-azd-tf` |
| JavaScript | `functions-quickstart-javascript-azd` | `functions-quickstart-javascript-azd-tf` |
| Python | `functions-quickstart-python-http-azd` | `functions-quickstart-python-http-azd-tf` |
| Java | `azure-functions-java-flex-consumption-azd` | `azure-functions-java-flex-consumption-azd-tf` |
| PowerShell | `functions-quickstart-powershell-azd` | `functions-quickstart-powershell-azd-tf` |

name: Info Needed Closer
on:
  schedule:
    - cron: 30 5 * * * # 10:30pm PT
  workflow_dispatch:

jobs:
  main:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    if: github.repository == 'microsoft/GitHub-Copilot-for-Azure'
    steps:
      - name: Checkout Actions
        uses: actions/checkout@v2
        with:
          repository: "microsoft/vscode-github-triage-actions"
          path: ./actions
          ref: stable
      - name: Install Actions
        run: npm install --production --prefix ./actions
      - name: Run Info Needed Closer
        uses: ./actions/needs-more-info-closer
        with:
          app_id: ${{ secrets.AZURETOOLS_VSCODE_BOT_APP_ID }}
          app_installation_id: ${{ secrets.AZURETOOLS_VSCODE_BOT_APP_INSTALLATION_ID }}
          app_private_key: ${{ secrets.AZURETOOLS_VSCODE_BOT_APP_PRIVATE_KEY }}
          label: info-needed
          closeDays: 14
          closeComment: "This issue has been closed automatically because it needs more information and has not had recent activity. See also our [issue reporting](https://aka.ms/azcodeissuereporting) guidelines.\n\nHappy Coding!"
          pingDays: 80
          pingComment: "Hey @${assignee}, this issue might need further attention.\n\n@${author}, you can help us out by closing this issue if the problem no longer exists, or adding more information."

  stale-pr-with-unresolved-comments:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.repository == 'microsoft/GitHub-Copilot-for-Azure'
    steps:
      - name: Find stale PRs with unresolved comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the cutoff timestamp (28 days ago) as Unix timestamp
          CUTOFF_TIMESTAMP=$(($(date +%s) - 28*24*60*60))

          REPO_OWNER="microsoft"
          REPO_NAME="GitHub-Copilot-for-Azure"

          echo "Finding open non-draft PRs with latest commit before: $(date -d @$CUTOFF_TIMESTAMP +%Y-%m-%dT%H:%M:%S%z)"
          echo ""

          # Get all open, non-draft PRs
          gh pr list \
            --repo ${REPO_OWNER}/${REPO_NAME} \
            --state open \
            --json number,title,isDraft,author \
            --jq '.[] | select(.isDraft == false)' | jq -s '.' > prs.json

          # Process each PR
          echo "Stale PRs with unresolved comments:"
          echo "===================================="

          jq -c '.[]' prs.json | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            PR_TITLE=$(echo "$pr" | jq -r '.title')
            PR_AUTHOR=$(echo "$pr" | jq -r '.author.login')

            # Get review threads and latest commit time using GraphQL
            PR_DATA=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $pr: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $pr) {
                    reviewThreads(first: 100) {
                      nodes {
                        isResolved
                      }
                    }
                    commits(last: 1) {
                      nodes {
                        commit {
                          committedDate
                        }
                      }
                    }
                  }
                }
              }
            ' -f owner="$REPO_OWNER" -f repo="$REPO_NAME" -F pr="$PR_NUMBER" 2>/dev/null)

            LATEST_COMMIT_DATE=$(echo "$PR_DATA" | jq -r '.data.repository.pullRequest.commits.nodes[0].commit.committedDate' 2>/dev/null || echo "")

            # Convert LATEST_COMMIT_DATE to Unix timestamp for comparison
            if [[ -z "$LATEST_COMMIT_DATE" ]]; then
              continue
            fi
            LATEST_COMMIT_TIMESTAMP=$(date -d "$LATEST_COMMIT_DATE" +%s 2>/dev/null || echo "0")

            # Check if latest commit was more than 28 days ago
            if [[ "$LATEST_COMMIT_TIMESTAMP" -lt "$CUTOFF_TIMESTAMP" ]]; then
              UNRESOLVED_THREADS=$(echo "$PR_DATA" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length' 2>/dev/null || echo "0")

              if [[ "$UNRESOLVED_THREADS" -gt 0 ]]; then
                echo "PR #${PR_NUMBER}: ${PR_TITLE}"
                echo "  Author: ${PR_AUTHOR}"
                echo "  Latest Commit: ${LATEST_COMMIT_DATE}"
                echo "  Unresolved Threads: ${UNRESOLVED_THREADS}"
                echo ""

                # Add comment and close the PR
                gh pr comment "$PR_NUMBER" \
                  --repo "${REPO_OWNER}/${REPO_NAME}" \
                  --body $'This PR has been automatically closed because it has unresolved review comments and no new commits in the last 28 days.\n\nIf you would still like to merge these changes, please:\n1. Resolve all outstanding review comments\n2. Reopen this PR\n\nThank you for your contribution!'

                gh pr close "$PR_NUMBER" \
                  --repo "${REPO_OWNER}/${REPO_NAME}"

                echo "  -> Closed PR #${PR_NUMBER}"
                echo ""
              fi
            fi
          done
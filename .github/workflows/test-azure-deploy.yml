# Test azure-deploy deployment tests
#
# Runs the deployment test groups for azure-deploy skill.
# Triggered manually.

name: Integration Tests - azure-deploy

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      test-pattern:
        description: 'Optional: Comma separated patterns by name or describe block (e.g. "creates todo list", "static-web-apps-deploy", "Terraform"). If empty, all tests will be run.'
        required: false
        type: string
        default: ''
      debug:
        description: 'Whether to set DEBUG=1 for jest tests'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      test-pattern:
        description: 'Optional: Comma delimited tests by name or describe block'
        required: false
        type: string
        default: ''
      debug:
        description: 'Whether to set DEBUG=1 for jest tests'
        required: false
        type: boolean
        default: false
    secrets:
      COPILOT_CLI_TOKEN:
        required: true

jobs:
  setup:
    name: Build test matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Parse test-pattern input into matrix
        id: set-matrix
        run: |
          INPUT="${{ inputs.test-pattern }}"
          # Default test groups if input is empty
          DEFAULT='["skill-invocation","static-web-apps-deploy","app-service-deploy","azure-functions-deploy","azure-container-apps-deploy","brownfield-dotnet","brownfield-javascript","brownfield-python"]'
          
          if [ -z "$INPUT" ]; then
            echo "matrix=$DEFAULT" >> "$GITHUB_OUTPUT"
          else
            # Convert comma-delimited input to JSON array
            JSON=$(echo "$INPUT" | tr ',' '\n' | sed 's/^ *//;s/ *$//' | jq -R . | jq -sc .)
            echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          fi

  test:
    name: azure-deploy – ${{ matrix.test-group }}
    needs: setup
    environment: cideploytest
    runs-on: ubuntu-latest
    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        test-group: ${{ fromJson(needs.setup.outputs.matrix) }}
    defaults:
      run:
        working-directory: tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install azd
        uses: Azure/setup-azd@v2

      - name: Log in with Azure (Federated Credentials)
        run: |
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
        shell: pwsh

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      # azure/login only fetches the OIDC access token once.
      # If a test starts after the token expires, it will fail with authentication errors.
      # This step runs code to refresh the cached OIDC access token periodically to ensure all tests have a valid access token.
      # Learn more at https://github.com/Azure/login/issues/372
      - name: Fetch OIDC token every 300 seconds
        shell: bash
        env:
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
        run: |
          while true; do
            token=$(curl -s -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://AzureADTokenExchange" | jq .value -r)
            az login --service-principal -u $AZURE_CLIENT_ID -t $AZURE_TENANT_ID --federated-token $token --output none
            sleep 300
          done &

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: npm ci
      
      # COPILOT_CLI_TOKEN must be a fine-grained access token with the Account level Copilot Request permission
      # saved to the secrets of the microsoft/GitHub-Copilot-for-Azure repo.
      # As a known issue, when the permission of the token doesn't grant sufficient access,
      # the agent will hang instead of giving an error.
      # If you see the agent hang indefinitely, try refreshing the access token.
      # See https://github.com/github/copilot-sdk/issues/343 for more details.
      - name: Setup Copilot CLI
        id: setup-copilot-cli
        uses: mvkaran/setup-copilot-cli@v1
        with:
          token: ${{ secrets.COPILOT_CLI_TOKEN }}

      - name: Run tests – ${{ matrix.test-group }}
        if: false
        env:
          GH_HEAD_SHA: ${{ github.sha }}
          DEBUG: ${{ inputs.debug && '1' || '' }}
        run: |
          npm run test:integration -- azure-deploy "${{ matrix.test-group }}"
        continue-on-error: true

      - name: Generate report
        if: always()
        id: generate-report
        run: npm run report -- --skill azure-deploy

      - name: Show skill report
        if: always()
        id: show-skill-report
        run: |
          SKILL_REPORT=$(find reports -name "*-SKILL-REPORT.md" -type f | head -n 1)
          if [ -n "$SKILL_REPORT" ]; then
            echo "Found skill report: $SKILL_REPORT"
            cat "$SKILL_REPORT" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No skill report found"
          fi

      - name: Export report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: azure-deploy-${{ matrix.test-group }}-reports
          path: tests/reports/
          retention-days: 30

  report:
    name: Aggregate results
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all report artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: azure-deploy-*-reports
          path: all-reports
          merge-multiple: true

      - name: Summarize
        run: |
          echo "## azure-deploy Integration Test Results" >> "$GITHUB_STEP_SUMMARY"
          for f in all-reports/*-SKILL-REPORT.md; do
            [ -f "$f" ] && cat "$f" >> "$GITHUB_STEP_SUMMARY" && echo "" >> "$GITHUB_STEP_SUMMARY"
          done

